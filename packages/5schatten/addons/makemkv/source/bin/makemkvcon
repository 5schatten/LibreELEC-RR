#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2018-present 5schatten (https://github.com/5schatten)

. /etc/profile

MAKEMKV_KEY=$(curl "https://www.makemkv.com/forum/viewtopic.php?f=5&t=1053" -s | awk 'FNR == 269 {print $13}'| cut -c 23-90)
SETTINGS_FILE=$HOME/.config/MakeMKV/settings.conf
ADDON_DIR="/storage/.kodi/addons/lib.multimedia.makemkv"


if [ -d /storage/.MakeMKV ]; then
  mkdir -p $HOME/.config/MakeMKV
  cp -R /storage/.MakeMKV/* /storage/.config/MakeMKV
  rm -rf /storage/.MakeMKV
  ln -s /storage/.config/MakeMKV /storage/.MakeMKV
fi

if [ ! -f $SETTINGS_FILE ]; then
  mkdir -p $HOME/.config/MakeMKV
  ln -s /storage/.config/MakeMKV /storage/.MakeMKV
  echo "app_Key=\"$MAKEMKV_KEY\"" > $SETTINGS_FILE
fi

if [ "$MAKEMKV_KEY" != "$(cat $SETTINGS_FILE| grep app_Key="*" | cut -c10-77)" ]; then
  sed -i '/app_Key=/d' $SETTINGS_FILE
  echo -e "\napp_Key=\"$MAKEMKV_KEY\"" >> $SETTINGS_FILE
  sed -i '/^\s*$/d' $SETTINGS_FILE
fi

export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$ADDON_DIR/lib"

makemkvcon.bin $@
